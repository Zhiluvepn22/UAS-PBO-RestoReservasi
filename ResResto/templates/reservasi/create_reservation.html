{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Buat Reservasi - {{ profile.name }}{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-100 via-white to-green-100 py-8">
  <div class="w-full max-w-2xl bg-white/90 p-10 rounded-3xl shadow-2xl border border-gray-200">
    <h1 class="text-4xl font-extrabold text-center mb-8 bg-gradient-to-r from-indigo-600 via-green-500 to-indigo-400 bg-clip-text text-transparent drop-shadow-lg">Formulir Reservasi</h1>
    <form method="post" id="reservationForm" class="space-y-6">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
          <div class="mb-4 p-3 bg-red-100 text-red-700 border border-red-300 rounded flex items-center gap-2">
            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01M21 12A9 9 0 1 1 3 12a9 9 0 0 1 18 0Z"/></svg>
            <div>
              {% for error in form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <!-- ========================================================== -->
        <!-- ==        PENAMBAHAN FIELD RUANGAN & PAKET MAKANAN        == -->
        <!-- ========================================================== -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="{{ form.room_type.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-1">{{ form.room_type.label }}</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 0 0 1 1h3m10-11l2 2m-2-2v10a1 1 0 0 1-1 1h-3m-6 0a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1m-6 0h6"/></svg>
              </span>
              {{ form.room_type|add_class:"pl-10 py-2 px-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-purple-400 focus:border-purple-500 transition appearance-none" }}
            </div>
            {% if form.room_type.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.room_type.errors.0 }}</p>{% endif %}
          </div>
          <div>
            <label for="{{ form.food_package.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-1">{{ form.food_package.label }}</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.59-5.58L4 12l8 8 8-8z"/></svg>
              </span>
              {{ form.food_package|add_class:"pl-10 py-2 px-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-yellow-400 focus:border-yellow-500 transition appearance-none" }}
            </div>
            {% if form.food_package.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.food_package.errors.0 }}</p>{% endif %}
          </div>
        </div>
        <!-- ========================================================== -->
        <!-- ==                   AKHIR PENAMBAHAN                   == -->
        <!-- ========================================================== -->

        {# --- FIELD RESERVASI LAINNYA (TANGGAL, WAKTU, JUMLAH TAMU) --- #}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label for="{{ form.reservation_date.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-1">{{ form.reservation_date.label }}</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z"/></svg>
              </span>
              {{ form.reservation_date|add_class:"pl-10 py-2 px-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-indigo-400 focus:border-indigo-500 transition" }}
            </div>
            {% if form.reservation_date.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.reservation_date.errors.0 }}</p>{% endif %}
          </div>
          <div>
            <label for="{{ form.reservation_time.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-1">{{ form.reservation_time.label }}</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>
              </span>
              {{ form.reservation_time|add_class:"pl-10 py-2 px-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-indigo-400 focus:border-indigo-500 transition appearance-none" }}
              <div id="timeSlotsLoading" class="text-sm text-gray-500 mt-1 hidden">Memuat slot waktu...</div>
            </div>
            {% if form.reservation_time.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.reservation_time.errors.0 }}</p>{% endif %}
          </div>
          <div>
            <label for="{{ form.number_of_guests.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-1">{{ form.number_of_guests.label }}</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg class="w-5 h-5 text-pink-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2h5"/></svg>
              </span>
              {{ form.number_of_guests|add_class:"pl-10 py-2 px-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-pink-400 focus:border-pink-500 transition" }}
            </div>
            {% if form.number_of_guests.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.number_of_guests.errors.0 }}</p>{% endif %}
          </div>
        </div>
      
        <hr class="my-6 border-gray-200">

        {# --- BLOK KONDISIONAL UNTUK DETAIL TAMU --- #}
        {% if not user.is_authenticated %}
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="{{ form.guest_name.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-1">{{ form.guest_name.label }}</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0 1 12 15c2.5 0 4.847.655 6.879 1.804M15 11a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>
                </span>
                {{ form.guest_name|add_class:"pl-10 py-2 px-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-green-400 focus:border-green-500 transition" }}
              </div>
              {% if form.guest_name.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.guest_name.errors.0 }}</p>{% endif %}
            </div>
            <div>
              <label for="{{ form.guest_phone.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-1">{{ form.guest_phone.label }}</label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5h2l.4 2M7 13h10l4-8H5.4M7 13l-1.35 2.7a1 1 0 0 0 .9 1.45h12.2a1 1 0 0 0 .9-1.45L17 13M7 13V6a1 1 0 0 1 1-1h5a1 1 0 0 1 1 1v7"/></svg>
                </span>
                {{ form.guest_phone|add_class:"pl-10 py-2 px-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-green-400 focus:border-green-500 transition" }}
              </div>
              {% if form.guest_phone.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.guest_phone.errors.0 }}</p>{% endif %}
            </div>
          </div>
          <div class="mt-6">
            <label for="{{ form.guest_email.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-1">{{ form.guest_email.label }}</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 12H8m8 0a4 4 0 1 1-8 0 4 4 0 0 1 8 0Zm0 0v1a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2v-1"/></svg>
              </span>
              {{ form.guest_email|add_class:"pl-10 py-2 px-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-green-400 focus:border-green-500 transition" }}
            </div>
            {% if form.guest_email.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.guest_email.errors.0 }}</p>{% endif %}
          </div>
        {% else %} 
          <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-md">
            <p class="text-sm text-indigo-700 flex items-center gap-2">
              <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0 1 12 15c2.5 0 4.847.655 6.879 1.804M15 11a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>
              Anda melakukan reservasi sebagai: <strong>{{ user.get_full_name|default:user.username }}</strong>
              {% if user.email %} 
                ({{ user.email }})
              {% else %}
                <span class="text-red-500 font-semibold">(Email Anda belum terdaftar, silakan isi di bawah)</span>
              {% endif %}
            </p>
            {{ form.guest_name.as_hidden }}
            {% if user.email %}
                {{ form.guest_email.as_hidden }}
            {% else %}
                <div class="mt-4">
                    <label for="{{ form.guest_email.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-1">{{ form.guest_email.label }} <span class="text-red-500 font-bold">(Wajib diisi)</span></label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 12H8m8 0a4 4 0 1 1-8 0 4 4 0 0 1 8 0Zm0 0v1a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2v-1"/></svg>
                        </span>
                        {{ form.guest_email|add_class:"pl-10 py-2 px-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-green-400 focus:border-green-500 transition" }}
                    </div>
                    {% if form.guest_email.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.guest_email.errors.0 }}</p>{% endif %}
                </div>
            {% endif %}
            <div class="mt-4"> 
              <label for="{{ form.guest_phone.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-1">{{ form.guest_phone.label }} <span class="text-gray-500">(Wajib diisi)</span></label>
              <div class="relative">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5h2l.4 2M7 13h10l4-8H5.4M7 13l-1.35 2.7a1 1 0 0 0 .9 1.45h12.2a1 1 0 0 0 .9-1.45L17 13M7 13V6a1 1 0 0 1 1-1h5a1 1 0 0 1 1 1v7"/></svg>
                </span>
                {{ form.guest_phone|add_class:"pl-10 py-2 px-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-green-400 focus:border-green-500 transition" }}
              </div>
              {% if form.guest_phone.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.guest_phone.errors.0 }}</p>{% endif %}
            </div>
          </div>
        {% endif %}
        
        <div class="mt-6">
          <label for="{{ form.special_requests.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-1">{{ form.special_requests.label }}</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pt-3 pl-3 pointer-events-none">
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 20h9"/></svg>
            </span>
            {{ form.special_requests|add_class:"pl-10 py-2 px-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-green-400 focus:border-green-500 transition" }}
          </div>
          {% if form.special_requests.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.special_requests.errors.0 }}</p>{% endif %}
        </div>
        
        <hr class="my-8 border-gray-200">

        {# --- Tombol Submit dan Waiting List --- #}
        {% if form.is_waitlist_candidate %}
          {# ... (logika tombol waiting list tetap sama) ... #}
        {% else %}
          <div class="text-center">
            <button type="submit" name="submit_reservation" class="w-full bg-gradient-to-r from-indigo-600 to-green-500 hover:from-indigo-700 hover:to-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-all duration-200 text-lg">
              Kirim Reservasi
            </button>
          </div>
        {% endif %}
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{# ... (JavaScript Anda tetap sama, tidak perlu diubah) ... #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('{{ form.reservation_date.id_for_label }}');
        const timeSelect = document.getElementById('{{ form.reservation_time.id_for_label }}');
        const timeSlotsLoading = document.getElementById('timeSlotsLoading');

        // Set tanggal minimum untuk date picker
        const today = new Date().toISOString().split('T')[0];
        dateInput.setAttribute('min', today);

        // Jika ada nilai tanggal awal (misal saat form error dan reload)
        if (dateInput.value) {
            fetchTimeSlots(dateInput.value);
        }

        dateInput.addEventListener('change', function() {
            const selectedDate = this.value;
            if (selectedDate) {
                fetchTimeSlots(selectedDate);
            } else {
                timeSelect.innerHTML = '<option value="">Pilih Tanggal Dahulu</option>';
            }
        });

        function fetchTimeSlots(date) {
            timeSelect.innerHTML = '<option value="">Memuat...</option>';
            timeSlotsLoading.classList.remove('hidden');

            fetch(`{% url 'reservasi:ajax_get_time_slots' %}?date=${date}`)
                .then(response => {
                    if (!response.ok) { throw new Error('Network response was not ok'); }
                    return response.json();
                })
                .then(data => {
                    timeSlotsLoading.classList.add('hidden');
                    timeSelect.innerHTML = '<option value="">Pilih Waktu</option>';
                    if (data.time_slots && data.time_slots.length > 0) {
                        data.time_slots.forEach(slot => {
                            const option = document.createElement('option');
                            option.value = slot.time_value;
                            option.textContent = `${slot.time_display} (Sisa: ${slot.remaining_capacity} tamu)`;
                            timeSelect.appendChild(option);
                        });
                    } else if (data.error) {
                         timeSelect.innerHTML = `<option value="">Error: ${data.error}</option>`;
                    } else {
                        timeSelect.innerHTML = '<option value="">Tidak ada slot tersedia</option>';
                    }
                })
                .catch(error => {
                    timeSlotsLoading.classList.add('hidden');
                    console.error('Error fetching time slots:', error);
                    timeSelect.innerHTML = '<option value="">Gagal memuat waktu</option>';
                });
        }
    });
</script>
{% endblock %}